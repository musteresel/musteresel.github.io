<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1.0,
                                   user-scalable=yes">
    <meta name="author" content="Daniel Jour">
            <meta name="dcterms.date" content="2017-07-11">
                <title>Open a console connection to a Xen VM – musteresel's blog</title>
    <script async defer src="../../../js.min.js"></script>
    <style>code{white-space: pre;}</style>
        <link rel="stylesheet" type="text/css" href="../../../css.min.css">
            <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <header>
      <p class="heading"><a href="../../../index.html">musteresel's blog</a></p>
    </header>
    <hr>
    <article>
            <header>
        <h1 class="title">Open a console connection to a Xen VM</h1>
                                <p class="date">2017-07-11</p>
                        <p class="tags">tagged:
                    <a href="../../../posts/tagged/xen/index.html">xen</a></p>
              </header>
            <p>I need to setup some virtual machines running on a Xen server which don’t have a ssh server running yet. One can access such VMs easily with Xen management software like XenCenter, but I prefer the UNIX philosophy “do one thing and do it well” and instead have a tool to do <em>just</em> that: give me a connection to one console of one virtual machine of some Xen server.</p>
<p>It took me a while to dig out the correct Xen API calls, but <a href="http://xapi-project.github.io/xen-api/consoles.html">description of consoles of the xapi-project</a> sums it up pretty well. In short:</p>
<ol type="1">
<li><p>Login at the Xen server to create new session with <code>Session.login_with_password</code></p></li>
<li><p>Get a reference to the virtual machine, e.g. by name with <code>VM.get_by_name_label</code></p></li>
<li><p>Get a list of consoles of that VM: <code>VM.get_consoles</code></p></li>
<li><p>Find a console with protocol <code>vt100</code> by looking at <code>console.get_protocol</code></p></li>
<li><p>Get the “location” of the console: <code>console.get_location</code></p></li>
<li><p>Depending on the locations protocol …</p>
<ul>
<li>if it’s <code>https</code>, then use <a href="https://www.gnutls.org/manual/html_node/gnutls_002dcli-Invocation.html"><code>gnutls-cli</code></a> or <a href="https://wiki.openssl.org/index.php/Manual:S_client(1)"><code>openssl s_client</code></a>, …</li>
<li>otherwise (<code>http</code>) using <code>telnet</code> is sufficient to connect to the location’s host</li>
</ul></li>
<li><p>Encode username and password for authorization:</p>
<pre><code>echo -n &quot;user:pass&quot; | base64</code></pre></li>
<li><p>send, <strong>with CR-LF line endings</strong> and <em>two</em> empty lines at the end:</p>
<pre><code>CONNECT &lt;location&gt; HTTP/1.1
Authorization: Basic &lt;encoded-user-pass&gt;

</code></pre></li>
<li><p>use connection as <code>vt100</code> terminal.</p></li>
</ol>
<p>Doing this manually on the command line actually worked pretty well, except the terminal was “crippled” (the local terminal probably needs to be configured somehow, probably like done in <a href="https://github.com/pyserial/pyserial/blob/master/serial/tools/miniterm.py">miniterm</a>). It worked good enough to install an ssh server, though.</p>
<p>The same should work with VNC consoles, too. Then I could setup a local port and redirect any traffic to the remote connection which I previously would set up like described above. Any VNC viewer should then be able to connect to my local port.</p>
<p>Also note that - contrary to the Xen API docs (shipped with the Xen SDK) - one needs to make the HTTP connect request with <code>HTTP/1.1</code> (got the idea to try this from <a href="https://discussions.citrix.com/topic/243319-how-to-retrieve-vnc-consoles-via-the-xenserver-sdk-api/">this only partly related discussion</a>).</p>
            <hr>
      <footer>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfV7TfT4OIcpopar3hBoLnzHBmbOi85ysjX23cQsvKzBCy4Dw/viewform?usp=pp_url&entry.1949939362=posts/2017/07/xen-vm-console-connection.html">
          Send me a message regarding this post</a>
      </footer>
      
    </article>
    <hr>
    <footer>
      <a href="../../../legal.html">Legal Notice / Impressum</a>
      &nbsp;&nbsp;
      <a href="../../../privacy.html">Privacy / Datenschutz</a>
    </footer>
  </body>
</html>
